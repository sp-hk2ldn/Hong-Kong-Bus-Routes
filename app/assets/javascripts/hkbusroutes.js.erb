var App;

App = angular.module('hkBusRoutes', ['ngRoute', 'templates', 'leaflet-directive', 'ngAnimate', 'ngMaterial']);

App.config([
  '$routeProvider', '$locationProvider', function($routeProvider, $locationProvider) {
    $routeProvider.when('/', {
      templateUrl: "index.html.erb"
    });
  return $locationProvider.html5Mode(true);
  }
]);

App.service('route',  function route($http, $q){
    var route = this;
    route.routeList = {};

    route.getAllRoutes = function(){
        var defer = $q.defer();

        $http.get('/routes')
                .success(function(response){
                    route.routeList = response;
                    defer.resolve(response);
                })
                .error(function(error, status){
                    defer.reject(error);
                });

        return defer.promise;
    };
    route.getOneRoute = function(id){
        var defer = $q.defer();

        $http.get('/routes/' + id)
                .success(function(response){
                    route.currentRoute = response;
                    defer.resolve(response);
                })
                .error(function(error, status){
                    defer.reject(error);
                });

        return defer.promise;
    };

    return route;

});

App.controller("RoutesCtrl", function($scope, route, $timeout, $q, $log, $http){

    $scope.init = function() {
        $scope.getAll();
    };


    $scope.containerForSingleRouteFunction = function(id) {
        $scope.replacementSingleRouteFunction(id);
    }


    $scope.getAll = function(){
        route.getAllRoutes()
                .then(function(response){
                    //success

                    self.routes = response;
                    return route.routeList;
                }, function(error) {
                    //error
                }, function(message) {
                    //message
                });
    };

    $scope.getSingleRoute = function(id){
        route.getOneRoute(id)
                .then(function(response){
                    //success

                    self.selectedItem = response;
                    return route.currentRoute;
                }, function(error) {
                    console.log("errored");
                    return;
                    //error
                }, function(message) {

                });
    };

    var self = this;
    self.searchText = null;
    self.querySearch = querySearch;
    self.simulateQuery = true;
    self.isDisabled = false;
    self.selectedItemChange = selectedItemChange;
    self.searchTextChange = searchTextChange;
    self.selectedItem = null;

    function querySearch (q) {
        var results = q ? self.routes.filter(createFilterFor(q) ) : [],
                deferred;
        if (self.simulateQuery) {
            deferred = $q.defer();
            $timeout(function() { deferred.resolve( results ); }, Math.random() * 1000, false);
        return deferred.promise;
        } else {
            return results;
        }
    }
    function searchTextChange (text) {
        $log.info('Text changed to ' + text);
    }
    function createFilterFor(query) {
        var lowerCaseQuery = angular.lowercase(query);
        return function FilterFn(route) {
            return (route.route_from_to.toLowerCase().indexOf(lowerCaseQuery) === 0);
        };
    }
    function selectedItemChange (item) {
        $log.info('Item changed to ' + item.route_from_to);

        console.log(self.selectedItem);
    }


    $scope.init();
});

App.controller("CenterController", [ '$scope', function($scope) {
    angular.extend($scope, {
        center: {
            lat: 40.095,
            lng: -3.823,
            zoom: 8
        },
        defaults: {
            scrollWheelZoom: false
        }
    });
}]);